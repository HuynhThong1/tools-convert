#!/usr/bin/env node

/**
 * Quick OAuth Setup Script
 * Generates the OAuth authorization URL for easy setup
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(query) {
  return new Promise(resolve => rl.question(query, resolve));
}

async function main() {
  console.log('\nðŸ” YouTube Audio Converter - Quick OAuth Setup\n');
  console.log('=' .repeat(60));

  console.log('\nThis script will help you get your OAuth credentials.\n');

  // Check if .env.local exists
  const envPath = path.join(process.cwd(), '.env.local');
  let envContent = '';

  if (fs.existsSync(envPath)) {
    envContent = fs.readFileSync(envPath, 'utf8');
  }

  // Get Client ID
  console.log('Step 1: Google Cloud Credentials');
  console.log('-' .repeat(60));
  console.log('If you don\'t have these yet:');
  console.log('1. Go to: https://console.cloud.google.com/');
  console.log('2. Create a project');
  console.log('3. Enable YouTube Data API v3');
  console.log('4. Create OAuth Client ID credentials\n');

  const clientId = await question('Enter your Google Client ID: ');

  if (!clientId || clientId.trim() === '') {
    console.log('\nâŒ Client ID is required. Exiting...\n');
    rl.close();
    return;
  }

  const clientSecret = await question('Enter your Google Client Secret: ');

  if (!clientSecret || clientSecret.trim() === '') {
    console.log('\nâŒ Client Secret is required. Exiting...\n');
    rl.close();
    return;
  }

  // Generate OAuth URL
  console.log('\n' + '=' .repeat(60));
  console.log('\nStep 2: Get Your Refresh Token');
  console.log('-' .repeat(60));

  const redirectUri = 'http://localhost:3000/api/auth/callback';
  const scope = 'https://www.googleapis.com/auth/youtube.readonly';

  const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
    `client_id=${encodeURIComponent(clientId)}&` +
    `redirect_uri=${encodeURIComponent(redirectUri)}&` +
    `response_type=code&` +
    `scope=${encodeURIComponent(scope)}&` +
    `access_type=offline&` +
    `prompt=consent`;

  console.log('\nðŸ“‹ Instructions:\n');
  console.log('1. Start your development server:');
  console.log('   npm run dev\n');
  console.log('2. Visit this URL in your browser:\n');
  console.log(authUrl);
  console.log('\n3. Sign in with your Google account');
  console.log('4. Allow the requested permissions');
  console.log('5. Copy the REFRESH TOKEN from the callback page\n');

  const openBrowser = await question('Open this URL in your default browser? (y/n): ');

  if (openBrowser.toLowerCase() === 'y') {
    const open = (await import('open')).default;
    await open(authUrl);
    console.log('âœ… Browser opened!\n');
  }

  const refreshToken = await question('\nPaste your Refresh Token here: ');

  if (!refreshToken || refreshToken.trim() === '') {
    console.log('\nâš ï¸  No refresh token provided. You can add it later.\n');
  }

  // Update .env.local
  console.log('\n' + '=' .repeat(60));
  console.log('\nStep 3: Saving Configuration');
  console.log('-' .repeat(60));

  // Build new env content
  const newEnvLines = [
    '# Google OAuth Configuration',
    '# Auto-generated by quick-oauth-setup.js',
    '',
    `GOOGLE_CLIENT_ID=${clientId.trim()}`,
    `GOOGLE_CLIENT_SECRET=${clientSecret.trim()}`,
  ];

  if (refreshToken && refreshToken.trim() !== '') {
    newEnvLines.push(`GOOGLE_REFRESH_TOKEN=${refreshToken.trim()}`);
  } else {
    newEnvLines.push('# GOOGLE_REFRESH_TOKEN=paste_your_refresh_token_here');
  }

  newEnvLines.push('');
  newEnvLines.push('# Application URL');
  newEnvLines.push('NEXT_PUBLIC_APP_URL=http://localhost:3000');
  newEnvLines.push('');

  fs.writeFileSync(envPath, newEnvLines.join('\n'));

  console.log(`\nâœ… Configuration saved to: .env.local\n`);

  // Show summary
  console.log('=' .repeat(60));
  console.log('\nðŸ“‹ Summary:');
  console.log(`   âœ… Client ID: ${clientId.substring(0, 20)}...`);
  console.log(`   âœ… Client Secret: ${clientSecret.substring(0, 10)}...`);

  if (refreshToken && refreshToken.trim() !== '') {
    console.log(`   âœ… Refresh Token: ${refreshToken.substring(0, 10)}...`);
    console.log('\nâœ… OAuth is fully configured!');
  } else {
    console.log('   âš ï¸  Refresh Token: Not set');
    console.log('\nâš ï¸  Don\'t forget to add your refresh token to .env.local');
  }

  console.log('\nðŸ“– Next steps:');
  console.log('   1. npm run dev        - Start development server');
  console.log('   2. npm test           - Run tests');
  console.log('   3. Test downloading a video!\n');

  console.log('=' .repeat(60));
  console.log('');

  rl.close();
}

main().catch(error => {
  console.error('Error:', error);
  rl.close();
  process.exit(1);
});
